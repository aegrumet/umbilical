# umbilical

Lifeline services for podcast PWAs.

## environment variables

| name                 | description                                                     | default                                  |
| -------------------- | --------------------------------------------------------------- | ---------------------------------------- |
| `ENABLED_FEATURES`   | comma-separated list of features to enable                      | 'proxy,search,podroll,podping_websocket' |
| `UMBILICAL_KEYS`     | comma-separated list of valid signing keys (see authentication) | n/a                                      |
| `PI_API_KEY`         | PodcastIndex API key, used for search                           | n/a                                      |
| `PI_API_SECRET`      | PodcastIndex API secret , used for search                       | n/a                                      |
| `WEBPUSH_JWK_BASE64` | base64-encoded JSON Web Key for webpush                         | n/a                                      |
| `WEBPUSH_CONTACT`    | contact info (subject) for webpush                              | n/a                                      |
| `WEBPUSH_TEMPLATE`   | template for webpush notification messages                      | 'angular'                                |

## features and deployment types

Umbilical ships with a number of features whose availability depends on the
deployment type. Here is a list of deployment types:

| deployment type  | description                                    | lifetime (typical) | examples                                          |
| ---------------- | ---------------------------------------------- | ------------------ | ------------------------------------------------- |
| edge worker      | stateless function                             | &lt;1s             | Deno Deploy, Cloudflare Workers, Google Cloud Run |
| websocket server | stateful for the duration of socket connection | minutes to hours   | Deno Deploy, Cloudflare Workers, Google Cloud Run |
| server           | stateful for the duration of server process    | hours to days      | Digital Ocean App Platform                        |

Here is a list of features and compatible deployment types:

| feature           | description                                                                                     | deploy type              |
| ----------------- | ----------------------------------------------------------------------------------------------- | ------------------------ |
| proxy             | proxy RSS, chapters, and opml files                                                             | all                      |
| search            | proxy PodcastIndex search API                                                                   | all                      |
| podroll           | extract podroll from RSS and return as OPML                                                     | all                      |
| podping_websocket | relay podpings from Livewire's podping websocket service to a running PWA, for subscribed feeds | websocket server, server |
| podping_webpush   | send podpings to running or non-running PWAs using webpush, for subscribed feeds (see below)    | server                   |

## authentication

You must set `UMBILICAL_KEYS` in the runtime environment in order to serve
requests. It should be set to a comma-separated list of valid signing keys.

Signing keys are used by Umbilical to verify the request signature, which is
passed differently depending on the request type:

- HTTP: the signature is passed in the "X-Umbilical-Signature" request header.
- WebSocket: the signature is passed as the query string.

The request signature has following format:

```
    t=<timestamp in milliseconds>,s=<hmac>
```

The hmac is generated by concatenating the timestamp, a requestLine string
(defined below), and body payload with periods, then generating an HMAC
SHA256 using a signing key as the secret:

     s=<hmac-sha256(`${timestamp}.${requestLine}.${bodyText}`)>

The requestLine string is the request URL without the protocol (https:// or wss://), and including the query string for http(s) only.

Examples:

| request URL                                                                                                                          | requestLine                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------- |
| https://umbilical.example.com/API/worker/proxy?rss=https://example.com/feed.rss                                                      | umbilical.example.com/API/worker/proxy?rss=https://example.com/feed.rss |
| wss://umbilical.example.com/API/websocket/podping?t=1704348921430&s=9b0d3593a7f154e1f2e706526c0316d6a5ccd7ac89f70d11d92fcb13495db73a | umbilical.example.com/API/websocket/podping                             |
|                                                                                                                                      |                                                                         |

For PUT, POST, and DELETE requests, the bodyText is serialized JSON. For GET requests the bodyText is empty.

The hmac should be generated using one of the signing keys in `UMBILICAL_KEYS`.

To allow unauthenticated requests, set `UMBILICAL_KEYS` to "DANGEROUSLY_ALLOW_ALL".

See `src/verify.ts` for full details of signature verification.

[examples/authentication.md](examples/authentication.md) has example code for signing requests.

## proxy API

`GET /API/worker/proxy?rss=<rss url>`

`GET /API/worker/proxy?chapters=<chapters url>`

`GET /API/worker/proxy?opml=<opml url>`

Proxies the RSS, chapters, or opml url. Returns an error if the resource fails parsing. Returns the raw unparsed resource if parsing passes.

Philsophy: Proxy only known formats, to protect the service, but be otherwise unopinionated about parsing.

## search API

`GET /API/worker/search?q=<search query>`

Relays a query to [PodcastIndex's](https://podcastindex.org/) [Search Podcasts API](https://podcastindex-org.github.io/docs-api/#get-/search/byterm).

Requires the following environment variables to be set:

- `PI_API_KEY`
- `PI_API_SECRET`

You can sign up for free credentials at [api.podcastindex.org](https://api.podcastindex.org/).

## podroll API

`GET /API/worker/podroll?rss=<rss url>`

Returns the rss feed's podroll in OPML format.

Returns an error if the feed has no podroll.

Requires PodcastIndex credentials (see [search API](#search-api)).

## podping websocket API

Proxies podpings from [Livewire's podping websocket
service](https://livewire.io/podping-via-websockets/) via websocket to connected
clients.

By default, all podpings are filtered out. Clients must subscribe to URLs or IRIs of interest.

Also, clients MUST respond to a ping message with a pong message. If a client
fails to respond, it will be disconnected. Pings and Pongs are simple JSON
objects having top-level `ping` and `pong` properties, respectively.

Podping messages are passed unmodified using Livewire's format as either
`PodpingV0` or `PodpingV1` (see the post linked above for details).

Websocket Endpoint: `/API/websocket/podping`

API:

- `addRssUrls(string[])`: subscribe to podpings whose URLs (v0.x) or IRIs (v1.x) match the given strings
- `deleteRssUrls(string[])`: unsubscribe from podpings whose URLs (v0.x) or IRIs (v1.x) match the given strings

For matching purposes, url schemes and trailing slashes are ignored.

## podping webpush API (experimental)

Sends webpush notifications to subscribed clients.

Note: this feature requires an always-on server deployment, such as Digital
Ocean App Platform. Also, it relies on ephemeral storage, so deployments should
use a single vm or container, and clients should regularly re-push their
subscription.

API:

- `GET /API/server/podping-webpush/pubkey`: get the public key for webpush

  - response body:

    ```
    string
    ```

- `PUT /API/server/podping-webpush/subscription`: add push subscription for podping messages from the provided RSS URLs

  - body:

    ```
    {
        rssUrls: string[],
        pushSubscription: PushSubscription
    }
    ```

  - The push subscription should be a JSON object as returned by the [PushManager.subscribe()](https://developer.mozilla.org/en-US/docs/Web/API/PushManager/subscribe) method.
  - Subsequent calls overwrite previous state for the subscription.

- `DELETE /API/server/podping-webpush/subscription`: delete the push subscription

  - body:

    ```
    {
        pushSubscription: PushSubscription
    }
    ```

  - The push subscription should be a JSON object as returned by the [PushManager.subscribe()](https://developer.mozilla.org/en-US/docs/Web/API/PushManager/subscribe) method.

### notification templates

Webpush notifications are developer-customizable. To create a new template, add
a key to
[src/podping/webpush/notification-templates.ts](src/podping/webpush/notification-templates.ts)
and set `WEBPUSH_TEMPLATE` to that key in the runtime environment. Templates are
serialized JSON strings that use [Eta template
syntax](https://eta.js.org/docs/intro/template-syntax) to interpolate values from the podping message.

## deploy

The latest image for this repo is posted to [Docker Hub](https://hub.docker.com/r/aegrumet/umbilical/tags).

- Run on Cloudflare: [deploy/cloudflare](deploy/cloudflare)
- Run on Deno Deploy: [deploy/deno](deploy/deno)
- Run on Google Cloud Run: [deploy/gcloud/terraform](deploy/gcloud/terraform)
- Run on Digital Ocean App Platform: [deploy/digitaocean](deploy/digitalocean)
- Run on other clouds: submit pull request.

## warnings

Operating an open proxy is risky. We strongly recommend not using "DANGEROUSLY_ALLOW_ALL" in production.

## last word

Please consider supporting the index! For more info see **Help us out...** at [podcastindex.org](https://podcastindex.org).
